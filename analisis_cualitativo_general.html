<!-- Configurando el documento HTML con dependencias -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe de Respuestas Cualitativas (Sin Encabezados)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body className="bg-gray-100 font-sans">
  <!-- Contenedor principal -->
  <div id="root" className="container mx-auto p-6"></div>

  <!-- Componente React con JSX -->
  <script type="text/babel">
    const Report = () => {
      const [data, setData] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      // Cargando y procesando los datos del CSV
      React.useEffect(() => {
        const csv = loadFileData("columnas cualitativas - Sheet1.csv");
        Papa.parse(csv, {
          header: false, // Ignorando encabezados
          skipEmptyLines: true,
          transform: (value) => value ? value.trim().replace(/^"|"$/g, '') : '',
          complete: (results) => {
            // Ignorando la primera fila (encabezados)
            const responseData = results.data.slice(1).map(row => {
              // Concatenando todas las columnas de la fila en una sola cadena
              const combinedResponse = row.filter(val => val).join(' ').toLowerCase();
              if (!combinedResponse) return null; // Filtrar filas vacías
              return { combined: combinedResponse, morena: row[1] || '' }; // Guardando columna de Morena por separado
            }).filter(row => row !== null);

            // Clasificando temas
            const themes = {
              Seguridad: 0,
              Corrupción: 0,
              Infraestructura: 0,
              Promesas: 0,
              Apoyos: 0,
              Otros: 0
            };
            const sentiment = { Positivo: 0, Negativo: 0, Neutral: 0 };

            responseData.forEach(row => {
              const text = row.combined;
              // Clasificando temas
              if (text.includes('seguridad') || text.includes('delincuencia') || text.includes('policía') || text.includes('policias')) {
                themes.Seguridad += 1;
              }
              if (text.includes('corrupción') || text.includes('robar') || text.includes('tranza') || text.includes('ratas')) {
                themes.Corrupción += 1;
              }
              if (text.includes('calles') || text.includes('carreteras') || text.includes('drenaje') || text.includes('pavimentación') || text.includes('bache')) {
                themes.Infraestructura += 1;
              }
              if (text.includes('promesas') || text.includes('cumplan') || text.includes('campaña') || text.includes('pongan las pilas')) {
                themes.Promesas += 1;
              }
              if (text.includes('apoyo') || text.includes('ayuda') || text.includes('beca') || text.includes('viejitos') || text.includes('invalidos')) {
                themes.Apoyos += 1;
              }
              if (text && !text.includes('seguridad') && !text.includes('corrupción') && !text.includes('calles') && !text.includes('promesas') && !text.includes('apoyo') && !text.includes('delincuencia') && !text.includes('policía') && !text.includes('pongan las pilas') && !text.includes('carreteras') && !text.includes('drenaje') && !text.includes('pavimentación') && !text.includes('bache') && !text.includes('ayuda') && !text.includes('beca') && !text.includes('viejitos') && !text.includes('invalidos')) {
                themes.Otros += 1;
              }

              // Clasificando percepción de Morena (columna 2)
              const morenaResponse = row.morena.toLowerCase();
              if (morenaResponse.includes('buen') || morenaResponse.includes('positiva') || morenaResponse.includes('mejor') || morenaResponse.includes('ayud') || morenaResponse.includes('conforme')) {
                sentiment.Positivo += 1;
              } else if (morenaResponse.includes('corrupción') || morenaResponse.includes('robar') || morenaResponse.includes('inútil') || morenaResponse.includes('tranza') || morenaResponse.includes('mal') || morenaResponse.includes('faramalla')) {
                sentiment.Negativo += 1;
              } else if (morenaResponse) {
                sentiment.Neutral += 1;
              }
            });

            // Preparando datos para gráficos
            const themeData = Object.entries(themes).map(([name, count]) => ({ name, count }));
            const sentimentData = Object.entries(sentiment).filter(([_, count]) => count > 0).map(([name, count]) => ({ name, count }));

            setData({ raw: responseData, themeData, sentimentData });
            setLoading(false);
          },
          error: (err) => {
            console.error(err);
            setLoading(false);
          }
        });
      }, []);

      // Mostrando mensaje de carga
      if (loading) {
        return (
          <div className="text-center text-xl font-semibold text-gray-700">
            Cargando datos...
          </div>
        );
      }

      // Renderizando el informe
      return (
        <div className="bg-white rounded-lg shadow-lg p-6">
          {/* Resumen */}
          <h1 className="text-3xl font-bold text-gray-800 mb-4">Informe de Respuestas Cualitativas (Sin Encabezados)</h1>
          <p className="text-gray-600 mb-6">
            Este informe analiza las respuestas cualitativas de encuestados, tratadas como un conjunto de opiniones concatenadas por fila, ignorando los encabezados del archivo. Las respuestas se clasifican en temas principales (seguridad, corrupción, infraestructura, promesas incumplidas, apoyos sociales) para identificar preocupaciones comunes. También se evalúa el sentimiento hacia Morena basándose en la segunda columna de respuestas. Las visualizaciones destacan los temas más frecuentes y las percepciones sobre Morena, con un enfoque en posibles indicadores de voto desinformado, como quejas generales sin detalles específicos.
          </p>

          {/* Gráfico de barras: Temas principales */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Temas Principales en las Respuestas</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.BarChart data={data.themeData}>
                <Recharts.CartesianGrid strokeDasharray="3 3" />
                <Recharts.XAxis dataKey="name" fontSize={12} />
                <Recharts.YAxis fontSize={12} />
                <Recharts.Tooltip />
                <Recharts.Legend />
                <Recharts.Bar dataKey="count" fill="#3B82F6" />
              </Recharts.BarChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Gráfico de pastel: Sentimiento hacia Morena */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Sentimiento hacia Morena</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.PieChart>
                <Recharts.Pie
                  data={data.sentimentData}
                  dataKey="count"
                  nameKey="name"
                  cx="50%"
                  cy="50%"
                  outerRadius={150}
                  fill="#8884d8"
                  label={{ fontSize: 12 }}
                >
                  {data.sentimentData.map((entry, index) => (
                    <Recharts.Cell
                      key={`cell-${index}`}
                      fill={index === 0 ? '#10B981' : index === 1 ? '#EF4444' : '#F59E0B'}
                    />
                  ))}
                </Recharts.Pie>
                <Recharts.Tooltip />
                <Recharts.Legend />
              </Recharts.PieChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Conclusiones */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Conclusiones</h2>
          <p className="text-gray-600">
            De un total de {data.raw.length} filas con respuestas válidas, los temas más frecuentes son <strong>seguridad</strong> ({data.themeData.find(d => d.name === 'Seguridad')?.count || 0} menciones, incluyendo delincuencia y problemas con la policía), <strong>corrupción</strong> ({data.themeData.find(d => d.name === 'Corrupción')?.count || 0} menciones, con quejas sobre robos y "tranzas"), e <strong>infraestructura</strong> ({data.themeData.find(d => d.name === 'Infraestructura')?.count || 0} menciones, enfocadas en calles y drenaje). Las <strong>promesas incumplidas</strong> ({data.themeData.find(d => d.name === 'Promesas')?.count || 0} menciones) reflejan descontento con campañas que no se materializan, mientras que los <strong>apoyos sociales</strong> ({data.themeData.find(d => d.name === 'Apoyos')?.count || 0} menciones) reciben comentarios positivos, especialmente para adultos mayores. Sobre Morena, {data.sentimentData.find(d => d.name === 'Positivo')?.count || 0} respuestas son positivas (elogios por apoyos y mejoras), {data.sentimentData.find(d => d.name === 'Negativo')?.count || 0} son negativas (asociadas con corrupción e ineficiencia), y {data.sentimentData.find(d => d.name === 'Neutral')?.count || 0} son neutrales. Un dato interesante es la contradicción en las percepciones: algunos encuestados alaban los programas sociales de Morena, pero critican a los gobernantes locales por corrupción o inacción, lo que podría indicar desinformación al confundir niveles de gobierno o basarse en percepciones generales sin evidencia específica.
          </p>
        </div>
      );
    };

    // Renderizando el componente
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Report />);
  </script>
</body>
</html>