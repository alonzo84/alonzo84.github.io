<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe de Respuestas Cualitativas (Sin Encabezados, Vanilla)</title>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6">
    <div id="report" class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-3xl font-bold text-gray-800 mb-4">Informe de Respuestas Cualitativas (Sin Encabezados)</h1>
      <p id="loading" class="text-center text-xl font-semibold text-gray-700">Cargando datos...</p>
      <div id="content" class="hidden">
        <p class="text-gray-600 mb-6">
          Este informe analiza las respuestas cualitativas de encuestados, tratadas como un conjunto de opiniones concatenadas por fila, ignorando los encabezados del archivo. Las respuestas se clasifican en temas principales (seguridad, corrupción, infraestructura, promesas incumplidas, apoyos sociales) para identificar preocupaciones comunes. También se evalúa el sentimiento hacia Morena basándose en la segunda columna de respuestas. Las visualizaciones destacan los temas más frecuentes y las percepciones sobre Morena, con un enfoque en posibles indicadores de voto desinformado.
        </p>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Temas Principales en las Respuestas</h2>
        <canvas id="barChart" class="mb-8"></canvas>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Sentimiento hacia Morena</h2>
        <canvas id="pieChart" class="mb-8"></canvas>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Conclusiones</h2>
        <p id="conclusion" class="text-gray-600"></p>
      </div>
    </div>
  </div>

  <script>
    function loadData() {
      const csv = loadFileData("columnas cualitativas - Sheet1.csv");
      Papa.parse(csv, {
        header: false,
        skipEmptyLines: true,
        transform: value => value ? value.trim().replace(/^"|"$/g, '') : '',
        complete: results => {
          // Ignorando la primera fila (encabezados)
          const responseData = results.data.slice(1).map(row => {
            const combinedResponse = row.filter(val => val).join(' ').toLowerCase();
            if (!combinedResponse) return null;
            return { combined: combinedResponse, morena: row[1] || '' };
          }).filter(row => row !== null);

          // Clasificando temas
          const themes = { Seguridad: 0, Corrupción: 0, Infraestructura: 0, Promesas: 0, Apoyos: 0, Otros: 0 };
          const sentiment = { Positivo: 0, Negativo: 0, Neutral: 0 };

          responseData.forEach(row => {
            const text = row.combined;
            if (text.includes('seguridad') || text.includes('delincuencia') || text.includes('policía') || text.includes('policias')) {
              themes.Seguridad += 1;
            }
            if (text.includes('corrup ción') || text.includes('robar') || text.includes('tranza') || text.includes('ratas')) {
              themes.Corrupción += 1;
            }
            if (text.includes('calles') || text.includes('carreteras') || text.includes('drenaje') || text.includes('pavimentación') || text.includes('bache')) {
              themes.Infraestructura += 1;
            }
            if (text.includes('promesas') || text.includes('cumplan') || text.includes('campaña') || text.includes('pongan las pilas')) {
              themes.Promesas += 1;
            }
            if (text.includes('apoyo') || text.includes('ayuda') || text.includes('beca') || text.includes('viejitos') || text.includes('invalidos')) {
              themes.Apoyos += 1;
            }
            if (text && !text.includes('seguridad') && !text.includes('corrupción') && !text.includes('calles') && !text.includes('promesas') && !text.includes('apoyo') && !text.includes('delincuencia') && !text.includes('policía') && !text.includes('pongan las pilas') && !text.includes('carreteras') && !text.includes('drenaje') && !text.includes('pavimentación') && !text.includes('bache') && !text.includes('ayuda') && !text.includes('beca') && !text.includes('viejitos') && !text.includes('invalidos')) {
              themes.Otros += 1;
            }

            // Clasificando percepción de Morena
            const morenaResponse = row.morena.toLowerCase();
            if (morenaResponse.includes('buen') || morenaResponse.includes('positiva') || morenaResponse.includes('mejor') || morenaResponse.includes('ayud') || morenaResponse.includes('conforme')) {
              sentiment.Positivo += 1;
            } else if (morenaResponse.includes('corrupción') || morenaResponse.includes('robar') || morenaResponse.includes('inútil') || morenaResponse.includes('tranza') || morenaResponse.includes('mal') || morenaResponse.includes('faramalla')) {
              sentiment.Negativo += 1;
            } else if (morenaResponse) {
              sentiment.Neutral += 1;
            }
          });

          // Preparando datos para gráficos
          const themeData = Object.entries(themes).map(([name, count]) => ({ name, count }));
          const sentimentData = Object.entries(sentiment).filter(([_, count]) => count > 0).map(([name, count]) => ({ name, count }));

          // Renderizando gráficos
          renderBarChart(themeData);
          renderPieChart(sentimentData, responseData.length, themeData, sentimentData);
        },
        error: err => {
          console.error(err);
          document.getElementById('loading').textContent = 'Error al cargar los datos';
        }
      });
    }

    function renderBarChart(data) {
      const ctx = document.getElementById('barChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(item => item.name),
          datasets: [{
            label: 'Frecuencia de Temas',
            data: data.map(item => item.count),
            backgroundColor: '#3B82F6',
            borderColor: '#1E40AF',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, title: { display: true, text: 'Frecuencia' } }, x: { title: { display: true, text: 'Tema' } } },
          plugins: { legend: { display: true } }
        }
      });
    }

    function renderPieChart(data, totalResponses, themeData, sentimentData) {
      const ctx = document.getElementById('pieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.map(item => item.name),
          datasets: [{
            data: data.map(item => item.count),
            backgroundColor: ['#10B981', '#EF4444', '#F59E0B'],
            borderColor: ['#047857', '#B91C1C', '#B45309'],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } }
        }
      });

      // Mostrando contenido y conclusiones
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
      document.getElementById('conclusion').textContent = 
        `De un total de ${totalResponses} filas con respuestas válidas, los temas más frecuentes son Seguridad (${themeData.find(d => d.name === 'Seguridad')?.count || 0} menciones, incluyendo delincuencia y problemas con la policía), Corrupción (${themeData.find(d => d.name === 'Corrupción')?.count || 0} menciones, con quejas sobre robos y "tranzas"), e Infraestructura (${themeData.find(d => d.name === 'Infraestructura')?.count || 0} menciones, enfocadas en calles y drenaje). Las Promesas incumplidas (${themeData.find(d => d.name === 'Promesas')?.count || 0} menciones) reflejan descontento con campañas que no se materializan, mientras que los Apoyos sociales (${themeData.find(d => d.name === 'Apoyos')?.count || 0} menciones) reciben comentarios positivos. Sobre Morena, ${sentimentData.find(d => d.name === 'Positivo')?.count || 0} respuestas son positivas, ${sentimentData.find(d => d.name === 'Negativo')?.count || 0} son negativas, y ${sentimentData.find(d => d.name === 'Neutral')?.count || 0} son neutrales. Un dato interesante es la contradicción en las percepciones: algunos encuestados alaban los programas sociales de Morena, pero critican a los gobernantes locales por corrupción o inacción, lo que podría indicar desinformación al confundir niveles de gobierno o basarse en percepciones generales sin evidencia específica.`;
    }

    // Iniciar carga de datos
    loadData();
  </script>
</body>
</html>