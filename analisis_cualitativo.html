<!-- Configurando el documento HTML con dependencias -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe de Respuestas Cualitativas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body className="bg-gray-100 font-sans">
  <!-- Contenedor principal -->
  <div id="root" className="container mx-auto p-6"></div>

  <!-- Componente React con JSX -->
  <script type="text/babel">
    const Report = () => {
      const [data, setData] = React.useState(null);
      const [loading, setLoading] = React.useState(true);

      // Cargando y procesando los datos del CSV
      React.useEffect(() => {
        const csv = loadFileData("columnas cualitativas - Sheet1.csv");
        Papa.parse(csv, {
          header: true,
          skipEmptyLines: true,
          transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
          transform: (value, header) => value ? value.trim().replace(/^"|"$/g, '') : '',
          complete: (results) => {
            // Clasificando respuestas por temas
            const themes = {
              Seguridad: 0,
              Corrupción: 0,
              Infraestructura: 0,
              Promesas: 0,
              Apoyos: 0,
              Otros: 0
            };
            const sentiment = { Positivo: 0, Negativo: 0, Neutral: 0 };

            const cleanedData = results.data.map(row => {
              const responses = {
                mensajeGobernador1: row["Si pudieras decirle una sola cosa al próximo gobernador o gobernadora de BC, ¿qué sería? (me permitiria grabar su respuesta, esto sera anonimo y sera utilizado para agregar un mensaje que combine lo que todos los encuestados respondan) "] || '',
                percepcionMorena: row["Para lo siguiente nos permite grabar su mensaje: ¿Cuál es su percepción de Morena?"] || '',
                mensajeGobernador2: row["Si pudieras darle un mensaje al próximo gobernador o gobernadora de BC, ¿qué sería?"] || '',
                mensajeClaudia: row["A la presidenta Claudia?"] || ''
              };

              // Clasificando temas
              const allResponses = Object.values(responses).join(' ').toLowerCase();
              if (allResponses.includes('seguridad') || allResponses.includes('delincuencia') || allResponses.includes('policía')) {
                themes.Seguridad += 1;
              }
              if (allResponses.includes('corrupción') || allResponses.includes('robar') || allResponses.includes('tranza')) {
                themes.Corrupción += 1;
              }
              if (allResponses.includes('calles') || allResponses.includes('carreteras') || allResponses.includes('drenaje') || allResponses.includes('pavimentación')) {
                themes.Infraestructura += 1;
              }
              if (allResponses.includes('promesas') || allResponses.includes('cumplan') || allResponses.includes('campaña')) {
                themes.Promesas += 1;
              }
              if (allResponses.includes('apoyo') || allResponses.includes('ayuda') || allResponses.includes('beca') || allResponses.includes('viejitos')) {
                themes.Apoyos += 1;
              }
              if (allResponses && !allResponses.includes('seguridad') && !allResponses.includes('corrupción') && !allResponses.includes('calles') && !allResponses.includes('promesas') && !allResponses.includes('apoyo')) {
                themes.Otros += 1;
              }

              // Clasificando percepción de Morena
              const morenaResponse = responses.percepcionMorena.toLowerCase();
              if (morenaResponse.includes('buen') || morenaResponse.includes('positiva') || morenaResponse.includes('mejor') || morenaResponse.includes('ayud')) {
                sentiment.Positivo += 1;
              } else if (morenaResponse.includes('corrupción') || morenaResponse.includes('robar') || morenaResponse.includes('inútil') || morenaResponse.includes('tranza') || morenaResponse.includes('mal')) {
                sentiment.Negativo += 1;
              } else if (morenaResponse) {
                sentiment.Neutral += 1;
              }

              return responses;
            }).filter(row => Object.values(row).some(val => val)); // Filtrar filas vacías

            // Preparando datos para gráficos
            const themeData = Object.entries(themes).map(([name, count]) => ({ name, count }));
            const sentimentData = Object.entries(sentiment).filter(([_, count]) => count > 0).map(([name, count]) => ({ name, count }));

            setData({ raw: cleanedData, themeData, sentimentData });
            setLoading(false);
          },
          error: (err) => {
            console.error(err);
            setLoading(false);
          }
        });
      }, []);

      // Mostrando mensaje de carga
      if (loading) {
        return (
          <div className="text-center text-xl font-semibold text-gray-700">
            Cargando datos...
          </div>
        );
      }

      // Renderizando el informe
      return (
        <div className="bg-white rounded-lg shadow-lg p-6">
          {/* Resumen */}
          <h1 className="text-3xl font-bold text-gray-800 mb-4">Informe de Respuestas Cualitativas</h1>
          <p className="text-gray-600 mb-6">
            Este informe analiza las respuestas cualitativas de encuestados sobre mensajes al próximo gobernador o gobernadora de Baja California, percepciones de Morena, y mensajes a la presidenta Claudia. Las respuestas se clasifican por temas principales (seguridad, corrupción, infraestructura, promesas, apoyos) y se evalúa el sentimiento hacia Morena. Las visualizaciones destacan las prioridades de los encuestados y posibles indicadores de desinformación o descontento.
          </p>

          {/* Gráfico de barras: Temas principales */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Temas Principales en las Respuestas</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.BarChart data={data.themeData}>
                <Recharts.CartesianGrid strokeDasharray="3 3" />
                <Recharts.XAxis dataKey="name" fontSize={12} />
                <Recharts.YAxis fontSize={12} />
                <Recharts.Tooltip />
                <Recharts.Legend />
                <Recharts.Bar dataKey="count" fill="#3B82F6" />
              </Recharts.BarChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Gráfico de pastel: Sentimiento hacia Morena */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Sentimiento hacia Morena</h2>
          <div className="mb-8">
            <Recharts.ResponsiveContainer width="100%" height={400}>
              <Recharts.PieChart>
                <Recharts.Pie
                  data={data.sentimentData}
                  dataKey="count"
                  nameKey="name"
                  cx="50%"
                  cy="50%"
                  outerRadius={150}
                  fill="#8884d8"
                  label={{ fontSize: 12 }}
                >
                  {data.sentimentData.map((entry, index) => (
                    <Recharts.Cell
                      key={`cell-${index}`}
                      fill={index === 0 ? '#10B981' : index === 1 ? '#EF4444' : '#F59E0B'}
                    />
                  ))}
                </Recharts.Pie>
                <Recharts.Tooltip />
                <Recharts.Legend />
              </Recharts.PieChart>
            </Recharts.ResponsiveContainer>
          </div>

          {/* Conclusiones */}
          <h2 className="text-2xl font-semibold text-gray-700 mb-4">Conclusiones</h2>
          <p className="text-gray-600">
            Las respuestas reflejan preocupaciones significativas sobre <strong>seguridad</strong> (mencionada en múltiples respuestas sobre delincuencia y policías) y <strong>corrupción</strong> (quejas sobre robos y "tranzas"). La <strong>infraestructura</strong> (calles, drenaje, pavimentación) y el <strong>incumplimiento de promesas</strong> también son temas recurrentes, lo que sugiere descontento con la gestión actual y expectativas no cumplidas. Los <strong>apoyos sociales</strong> reciben menciones positivas, especialmente para adultos mayores, pero algunos encuestados critican su implementación. La percepción de Morena es mixta: {data.sentimentData.find(d => d.name === 'Positivo')?.count || 0} respuestas son positivas, destacando apoyos y mejoras, mientras que {data.sentimentData.find(d => d.name === 'Negativo')?.count || 0} son negativas, asociadas con corrupción y promesas incumplidas. Un dato interesante es la contradicción en las percepciones: algunos encuestados elogian a Morena por sus programas sociales, pero critican a los gobernantes locales por ineficiencia o corrupción, lo que podría indicar desinformación o confusión entre niveles de gobierno.
          </p>
        </div>
      );
    };

    // Renderizando el componente
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Report />);
  </script>
</body>
</html>